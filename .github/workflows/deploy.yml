name: Deploy AI Todo App to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        cd server && npm ci

    - name: Build applications
      run: |
        npm run build
        cd server && npm run build

    - name: Run tests (if available)
      run: |
        echo "Skipping tests for now - will implement later"
        echo "âœ… Test stage completed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e  # ì—ëŸ¬ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
          
          echo "ğŸš€ Starting deployment..."
          
          # ë°±ì—… ìƒì„±
          if [ -d "/home/ubuntu/ai-todo-app-backup" ]; then
            rm -rf /home/ubuntu/ai-todo-app-backup
          fi
          cp -r /home/ubuntu/ai-todo-app /home/ubuntu/ai-todo-app-backup
          echo "ğŸ“¦ Backup created"
          
          cd /home/ubuntu/ai-todo-app/
          
          # Git pull latest changes
          echo "â¬‡ï¸ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          # Install dependencies
          echo "ğŸ“‹ Installing dependencies..."
          npm install --only=production
          cd server && npm install --only=production && cd ..
          
          # Build applications
          echo "ğŸ”¨ Building applications..."
          npm run build
          cd server && npm run build && cd ..
          
          # Environment variables management
          echo "ğŸ”§ Managing environment variables..."
          if [ ! -f server/.env ]; then
            echo "Creating new .env file..."
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" > server/.env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> server/.env
            echo "PORT=2222" >> server/.env
            echo "NODE_ENV=production" >> server/.env
          else
            echo ".env file already exists, keeping existing configuration"
          fi
          
          # PM2 restart with better error handling
          echo "ğŸ”„ Restarting PM2 processes..."
          if pm2 list | grep -q "ai-todo-server"; then
            pm2 restart ai-todo-server
          else
            pm2 start server/dist/server.js --name "ai-todo-server"
          fi
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          sleep 5
          if curl -f http://localhost:2222/api/health 2>/dev/null; then
            echo "âœ… Health check passed"
          else
            echo "âš ï¸ Health check failed, but deployment completed"
          fi
          
          # Show PM2 status
          pm2 status
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ App is running at http://${{ secrets.EC2_HOST }}:2222"

    - name: Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Deployment successful!"
        else
          echo "âŒ Deployment failed. Check logs above."
        fi