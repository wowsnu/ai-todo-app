name: Deploy AI Todo App to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        cd server && npm ci

    - name: Build applications
      run: |
        npm run build
        cd server && npm run build

    - name: Run tests (if available)
      run: |
        echo "Skipping tests for now - will implement later"
        echo "âœ… Test stage completed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 2222
        script: |
          set -e  # ì—ëŸ¬ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
          
          echo "ğŸš€ Starting deployment..."
          
          # ë°±ì—… ìƒì„±
          if [ -d "/opt/ai-todo-app-backup" ]; then
            sudo rm -rf /opt/ai-todo-app-backup
          fi
          sudo cp -r /opt/ai-todo-app /opt/ai-todo-app-backup
          echo "ğŸ“¦ Backup created"
          
          cd /opt/ai-todo-app/
          
          # Git pull latest changes
          echo "â¬‡ï¸ Pulling latest changes..."
          sudo git fetch origin
          sudo git reset --hard origin/main
          
          # Install dependencies
          echo "ğŸ“‹ Installing dependencies..."
          sudo npm install
          cd server && sudo npm install && cd ..
          
          # Build applications
          echo "ğŸ”¨ Building applications..."
          sudo npm run build
          cd server && sudo npm run build && cd ..
          
          # Copy .env to dist directory for runtime
          echo "ğŸ“ Copying environment files..."
          sudo cp server/.env server/dist/.env
          
          # Create database directory and set permissions
          echo "ğŸ—„ï¸ Setting up database..."
          sudo mkdir -p server/dist
          sudo touch server/dist/database.sqlite
          sudo chown ubuntu:ubuntu server/dist/database.sqlite
          sudo chmod 666 server/dist/database.sqlite
          
          # Environment variables management
          echo "ğŸ”§ Managing environment variables..."
          
          # Create PM2 ecosystem file with environment variables (preferred method)
          echo "Creating PM2 ecosystem configuration..."
          sudo tee ecosystem.config.js > /dev/null << 'EOF'
          module.exports = {
            apps: [{
              name: 'ai-todo-backend',
              script: './server/dist/server.js',
              env_production: {
                NODE_ENV: 'production',
                PORT: 2222,
                GOOGLE_CLIENT_ID: '${{ secrets.GOOGLE_CLIENT_ID }}',
                JWT_SECRET: '${{ secrets.JWT_SECRET }}',
                OPENAI_API_KEY: '${{ secrets.OPENAI_API_KEY }}'
              }
            }]
          };
          EOF
          
          # Create backup .env file (fallback)
          if [ ! -f server/.env ]; then
            echo "Creating backup .env file..."
            sudo mkdir -p server
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" | sudo tee server/.env > /dev/null
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" | sudo tee -a server/.env > /dev/null
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" | sudo tee -a server/.env > /dev/null
            echo "PORT=2222" | sudo tee -a server/.env > /dev/null
            echo "NODE_ENV=production" | sudo tee -a server/.env > /dev/null
            echo "âœ… Backup .env file created"
          else
            echo ".env file already exists, keeping existing configuration"
          fi
          
          # PM2 restart with ecosystem configuration (preferred method)
          echo "ğŸ”„ Restarting PM2 processes..."
          if pm2 list | grep -q "ai-todo-backend"; then
            echo "Stopping existing process..."
            pm2 stop ai-todo-backend
            pm2 delete ai-todo-backend
          fi
          
          echo "Starting with ecosystem configuration..."
          pm2 start ecosystem.config.js --env production
          pm2 save
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          sleep 5
          if curl -f http://localhost:2222/api/health 2>/dev/null; then
            echo "âœ… Health check passed"
          else
            echo "âš ï¸ Health check failed, but deployment completed"
          fi
          
          # Show PM2 status
          pm2 status
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ App is running at http://${{ secrets.EC2_HOST }}:2222"

    - name: Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Deployment successful!"
        else
          echo "âŒ Deployment failed. Check logs above."
        fi